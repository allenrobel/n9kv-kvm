# nexus9000v Configuration and Startup

## Download the nexus9000v image (Cisco Account Required)

- Follow the link below, click on Downloads, and select 10.3(8) Download Options.
- On this page, highlite 10.3(8)M and look for "Cisco Nexus 9000/3000 Virtual Switch for KVM"
- This image is labeled `nexus9300v64.10.3.8.M.qcow2`
- Later images might work, but we have not tested them (we'll update this page when we do).

[Nexus 9000v Download](https://www.cisco.com/c/en/us/support/switches/nexus-9000v-switch/model.html)

## Ansible Playbook

We will be using an Ansible playbook to generate the n9kv startup-config
ISO files.

- `$HOME/repos/n9kv-kvm/config/ansible/startup_config_iso.yaml`

## Jinja2 Template

This script uses a Jinja2 template to create the configs.

- `$HOME/repos/n9kv-kvm/config/ansible/nxos_startup_config.j2`

It then creates the ISO file, containing the startup-config
(renamed to `nxos_config.txt`), that n9kv will read as its
startup configuration.

## Jinja2 Template - Files Defining Template Variables

Have a look at the template.

- `$HOME/repos/n9kv-kvm/config/ansible/nxos_startup_config.j2`

The template generates the startup config containing what
is necessary for nexus9000v to boot and to be reachable to
Nexus Dashboard.

Below is an example config generated by the Ansible script and
Jinja2 template.

The first two lines (starting with !) are there so that nexus9000v
loads the config on first boot (On further debugging, we're not sure
these are needed, but they don't hurt.  We'll update this section
later if it's found these can be removed.)

```bash
!Time: Fri Jul 25 10:00:00 2025
!Startup config saved at: Fri Jul 25 10:00:00 2025
configure terminal
hostname ER
boot nxos bootflash:/nxos64-cs.10.3.8.M.bin

interface mgmt0
  no cdp enable
  vrf member management
  ip address 192.168.11.111/24
  no shutdown
```

Several items above are derived from variables located in two places, as shown below:

- `hostname` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`ER_HOSTNAME`)
- `boot nxos` : $HOME/repos/n9kv-kvm/config/ansible/startup_config_iso.yaml (`nxos_image` var)
- `ip address` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`ER_IP4`)

## Edit the startup_config_iso.yaml playbook

The `vars` section of this playbook contains the following items
that need to be modified for your environment.  The other items
in the `vars` section are populated based on the contents of
`$HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py`

```yaml
  vars:
    nxos_image: "nxos64-cs.10.3.8.M.bin"
    output_dir: "/iso/nxos/config"
```

- `nxos_image` - Set this to the image name (.bin) that is extracted from the n9kv `.qcow2` during bootup.
- `output_dir` - Set this to the location the n9kv startup config ISOs will be written to.

## Run the startup_config_iso.yaml playbook

```bash
cd $HOME/repos/n9kv-kvm/config/ansible
source $HOME/repos/n9kv-kvm/.venv/bin/activate
sudo ansible-playbook startup_config_iso.yaml -i dynamic_inventory.py
```

## Verify the ISO images are created

Substitute the path below with the value of `output_dir` from above.

```bash
(.venv) arobel@cvd-3:~/repos/n9kv-kvm/config/ansible$ ls -l /iso/nxos/config
total 1424
-rw-r--r-- 1 root root    172 Jul 28 20:39 ER.cfg
-rw-r--r-- 1 root root 358400 Jul 28 20:40 ER.iso
-rw-r--r-- 1 root root    172 Jul 28 20:39 L1.cfg
-rw-r--r-- 1 root root 358400 Jul 28 20:40 L1.iso
-rw-r--r-- 1 root root    172 Jul 28 20:39 S1.cfg
-rw-r--r-- 1 root root 358400 Jul 28 20:40 S1.iso
-rw-r--r-- 1 root root    172 Jul 28 20:39 S2.cfg
-rw-r--r-- 1 root root 358400 Jul 28 20:40 S2.iso
(.venv) arobel@cvd-3:~/repos/n9kv-kvm/config/ansible$
```

## nexus9000v Startup

### Review Shell Script Contents

Review the contents of the following script and make any modifications
e.g. for `CDROM_PATH` based on where you saved the config ISOs above,
and where you saved the nexus9000v qcow2 image.

```bash
cat $HOME/repos/n9kv-kvm/config/qemu/n9kv_qemu_ER.sh
```

In particular, verify that:

- `CDROM_PATH` and `CDROM_IMAGE` match the location where you saved the ISO config file (i.e. `output_dir`).
- `N9KV_SHARED_IMAGE` matches the location of the nexus9000v qcow2 image

### Run the ER Shell Script

```bash
cd $HOME/repos/n9kv-kvm/config/qemu/
sudo ./n9kv_qemu_ER.sh
# In the script output, you'll see the port number used
# to connect to the switch console
Console access:
telnet localhost 9011
```

### Connect to the ER Switch Console

```bash
telnet localhost 9011
```

You'll notice the following, but you can ignore it.  The shell script above
does try to resize the image, but that doesn't help.  If anyone has a solution,
open an issue in this repo and I'll update the docs (thanks!).  For now,
things seem to work OK with 4G size.

```bash
Bad Partition bootflash size 4G too small < min 8G
```

### Set the Password and Login

We've intentionally omitted a password setting in the startup config,
so you can set it when the nexus9000v boots to whatever local security
standards are applicable to you.

```bash
---- System Admin Account Setup ----


Do you want to enforce secure password standard (yes/no) [y]: no

  Enter the password for "admin": 
  Confirm the password for "admin": 


User Access Verification
ER login: admin
Password: 
# skipping copyright, etc...
ER#
```

Repeat the above for the other switches (S1, S2, L1).
