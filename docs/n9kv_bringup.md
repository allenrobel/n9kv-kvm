# nexus9000v Configuration and Startup

## Download the nexus9000v image (Cisco Account Required)

- Follow the link below, click on Downloads, and select from either 10.3(8) or 10.5(3) Download Options.
- On this page, highlite 10.3(8)M or 10.5(3)F and look for "Cisco Nexus 9000/3000 Virtual Switch for KVM"
- This image is labeled, depending on the version you've selected, either
  - `nexus9300v64.10.3.8.M.qcow2`
  - `nexus9300v64.10.5.3.F.qcow2`
- Other images might work, but we have not tested them (we'll update this page when we do).

[Nexus 9000v Download](https://www.cisco.com/c/en/us/support/switches/nexus-9000v-switch/model.html)

## Ansible Playbook

We will be using an Ansible playbook to generate the n9kv startup-config
ISO files.

- `$HOME/repos/n9kv-kvm/config/ansible/startup_config_iso.yaml`

## Jinja2 Template

This script uses a Jinja2 template to create the configs.

- `$HOME/repos/n9kv-kvm/config/ansible/nxos_startup_config.j2`

It then creates the ISO file, containing the startup-config
(renamed to `nxos_config.txt`), that n9kv will read as its
startup configuration.

## Jinja2 Template - Files Defining Template Variables

Have a look at the template.

- `$HOME/repos/n9kv-kvm/config/ansible/nxos_startup_config.j2`

The template generates the startup config containing what is necessary for
the nexus9000v to boot and to be both discoverable (over inter-switch links)
and reachable (over mgmt0 interface) by Nexus Dashboard.

Below is an example config generated by the Ansible script and
Jinja2 template.

The first two lines (starting with !) are there so that nexus9000v
loads the config on first boot (On further debugging, we're not sure
these are needed, but they don't hurt.  We'll update this section
later if it's found these can be removed.)

```bash
!Time: Fri Jul 25 10:00:00 2025
!Startup config saved at: Fri Jul 25 10:00:00 2025
configure terminal
hostname BG1
boot nxos bootflash:/nxos64-cs.10.5.3.F.bin

interface mgmt0
  no cdp enable
  vrf member management
  ip address 192.168.12.131/24
  no shutdown

interface Ethernet1/1
    no shutdown

interface Ethernet1/2
    no shutdown
```

Several items above are derived from variables located in two places, as shown below:

- `BG1` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`BG1_HOSTNAME`)
- `nxos64-cs.10.5.3.F.bin` : $HOME/repos/n9kv-kvm/config/ansible/startup_config_iso.yaml (`nxos_image` var)
- `192.168.12.131/24` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`BG1_IP4`)
- `Ethernet1/1` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`BG1_INTERFACE_1`)
- `Ethernet1/2` : $HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py (`BG1_INTERFACE_2`)

## Edit the startup_config_iso.yaml playbook

The `vars` section of this playbook contains the following items that need to be modified
for your environment.  The other items in the `vars` section are populated based on the
contents of `$HOME/repos/n9kv-kvm/config/ansible/dynamic_inventory.py`

```yaml
  vars:
    nxos_image: "nxos64-cs.10.5.3.F.bin"
    output_dir: "/iso2/nxos/config"
```

- `nxos_image` - Set this to the image name (.bin) that is extracted from the n9kv `.qcow2` during bootup. One of:
  - `nxos64-cs.10.5.3.F.bin`
  - `nxos64-cs.10.3.8.M.bin`
- `output_dir` - Set this to the location the n9kv startup config ISOs will be written to.

## Run the startup_config_iso.yaml playbook

If you want to store the ISO files in a location only writable by root, use the following.

```bash
cd $HOME/repos/n9kv-kvm/config/ansible
export PYTHONPATH=$HOME/repos/n9kv-kvm/.venv
sudo -E bash -c "source $HOME/repos/n9kv-kvm/.venv/bin/activate"; ansible-playbook startup_config_iso.yaml -i dynamic_inventory.py
```

Else, if the ISO files are being written to a location you have write access to:

```bash
cd $HOME/repos/n9kv-kvm/config/ansible
source $HOME/repos/n9kv-kvm/.venv/bin/activate
export PYTHONPATH=$HOME/repos/n9kv-kvm/.venv
ansible-playbook startup_config_iso.yaml -i dynamic_inventory.py
```

## Verify the ISO images are created

Substitute the path below with the value of `output_dir` from above.

```bash
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm$ ls -l /iso2/nxos/config/
total 46117076
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 BG1.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 BG1.iso
-rw-r--r-- 1 root   root   6035668992 Aug 18 05:03 BG1.qcow2
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 BG2.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 BG2.iso
-rw-r--r-- 1 root   root   6004015104 Aug 18 05:03 BG2.qcow2
-rw-r--r-- 1 arobel arobel        302 Aug 15 04:07 CR1.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 CR1.iso
-rw-r--r-- 1 root   root   5956173824 Aug 18 05:03 CR1.qcow2
-rw-r--r-- 1 arobel arobel        378 Aug 15 19:13 ER1.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 19:13 ER1.iso
-rw-r--r-- 1 root   root   5115805696 Aug 16 06:40 ER1.qcow2
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 LE1.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 LE1.iso
-rw-r--r-- 1 root   root   6027935744 Aug 18 05:03 LE1.qcow2
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 LE2.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 LE2.iso
-rw-r--r-- 1 root   root   6024527872 Aug 18 05:03 LE2.qcow2
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 SP1.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 SP1.iso
-rw-r--r-- 1 root   root   6027608064 Aug 18 05:03 SP1.qcow2
-rw-r--r-- 1 arobel arobel        340 Aug 15 04:07 SP2.cfg
-rw-rw-r-- 1 arobel arobel     358400 Aug 15 04:07 SP2.iso
-rw-r--r-- 1 root   root   6028787712 Aug 18 05:03 SP2.qcow2
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm$
```

## nexus9000v Startup

### Review YAML File Contents for Global Configuration

Review the contents of the following YAML configuration file:

```bash
cat $HOME/repos/n9kv/config/nexus9000v/global_config.yaml
```

```yaml
# global_config.yaml - Global settings for all switches
image_path: /iso1/nxos
cdrom_path: /iso2/nxos/config
bios_file: /usr/share/ovmf/OVMF.fd
default_image: nexus9300v64.10.3.8.M.qcow2
base_mac: "52:54:00"  # <- Add quotes here
default_ram: 16384
default_vcpus: 4
default_disk_size: 32G
default_interface_type: e1000
```

In particular, verify that:

- `image_path` matches the location of the nexus9000v qcow2 image.
- `cdrom_path` matches the location where you saved the ISO config files
  - i.e. `output_dir` in $HOME/repos/config/ansible/startup_config_iso.yaml

### Review YAML File Contents for individual switches

```bash
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm/config/nexus9000v$ ls -l *.yaml | grep -v global_config
-rw-rw-r-- 1 arobel arobel 181 Aug 16 06:41 BG1.yaml
-rw-rw-r-- 1 arobel arobel 181 Aug 16 06:42 BG2.yaml
-rw-rw-r-- 1 arobel arobel 150 Aug 15 23:36 CR1.yaml
-rw-rw-r-- 1 arobel arobel 196 Aug 15 23:36 ER1.yaml
-rw-rw-r-- 1 arobel arobel 175 Aug 15 23:36 LE1.yaml
-rw-rw-r-- 1 arobel arobel 175 Aug 15 23:36 LE2.yaml
-rw-rw-r-- 1 arobel arobel 177 Aug 15 23:36 SP1.yaml
-rw-rw-r-- 1 arobel arobel 177 Aug 15 23:36 SP2.yaml
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm/config/nexus9000v$
```

These files contain:

- The hostname of the switch
- The switch role
- The switch ID
- The management bridge (that interface mgmt0 connects to)
- The switch's neighbors
- The bridge names used to reach the switch's neighbors

Example for BG1 switch.

```yaml
---
# BG1.yaml - Border Gateway 1 configuration
name: BG1
role: Border Gateway
sid: 31
mgmt_bridge: BR_ND_DATA
neighbors:
  - BG2
  - SP1
isl_bridges:
  - BR_BG1_BG2
  - BR_BG1_SP1
```

### Run Python script that generates and starts the nexus9000v instances

```bash
cd $HOME/repos/n9kv-kvm/config/nexus9000v
sudo python3 nexus9000v.py --global-config global_config.yaml --config BG1.yaml 
```

In the script output, you'll see the port number used
to connect to the switch console

```bash
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm/config/nexus9000v$ sudo python3 nexus9000v.py --global-config global_config.yaml --config BG1.yaml
Image resized.
CR1 instance created.
Role: Border Gateway
SID: 31
BG1 -> BG2: BR_BG1_BG2

Console access: telnet localhost 9031
Monitor access: telnet localhost 4431
Process ID: 386740
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm/config/nexus9000v$
```

### Connect to the BG1 Switch Console

```bash
telnet localhost 9031
```

You'll notice the following, but you can ignore it.

```bash
Bad Partition bootflash size 4G too small < min 8G
```

### Be Patient

Give the nexus9000v time to boot (15-30 minutes).  It will spend a lot of this time
seemingly hung at `Loading system software`.  Patience is a virtue here!

### Set the Password and Login

We've intentionally omitted a password setting in the startup config,
so you can set it when the nexus9000v boots to whatever local security
standards are applicable to you.

```bash
---- System Admin Account Setup ----


Do you want to enforce secure password standard (yes/no) [y]: no

  Enter the password for "admin": 
  Confirm the password for "admin": 


User Access Verification
BG1 login: admin
Password: 
# skipping copyright, etc...
BG1#
```

To exit the console, use `Ctrl+]` (`control + ]` on a Mac) and then type `close` at the `telnet` prompt.

```bash
BG1#
telnet> close
Connection closed.
(n9kv-kvm) arobel@glide:~/repos/n9kv-kvm/config/nexus9000v$
```

Repeat the above for the other switches (BG2, SP1, SP2, LE1, LE2).
